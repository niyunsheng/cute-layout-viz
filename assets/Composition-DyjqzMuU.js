import{u as et,r as s,j as a}from"./index-CyG5ptUr.js";import{H as ot,L as A,t as f,p as W,g as B,c as st,o as at,a as q}from"./LayoutGrid-3uQWtmFK.js";import"./pyodide-GADaI8Wc.js";function it(){const[h]=et(),[p,j]=s.useState(()=>h.get("layoutA")||"(6,2):(8,2)"),[y,E]=s.useState(()=>h.get("layoutB")||"(4,3):(3,1)"),[b,I]=s.useState(""),[l,L]=s.useState(null),[F,$]=s.useState(!1),[D,J]=s.useState(!0),[w,K]=s.useState("viridis"),[r,N]=s.useState({gridData:[],rows:0,cols:0,parsedLayout:null,colCoords:[],rowCoords:[]}),[o,k]=s.useState({gridData:[],rows:0,cols:0,parsedLayout:null,colCoords:[],rowCoords:[]}),[g,H]=s.useState({gridData:[],rows:0,cols:0,parsedLayout:null,colCoords:[],rowCoords:[]}),[m,O]=s.useState([]),P=s.useRef([]),R=s.useRef([]),M=s.useRef([]);s.useEffect(()=>{const t=h.get("layoutA"),e=h.get("layoutB");t&&j(t),e&&E(e)},[h]),s.useEffect(()=>{(async()=>{try{I("");const e=await W(p),c=await B(e.shape,e.stride),n=await W(y),d=await B(n.shape,n.stride),i=await st(e.shape,e.stride,n.shape,n.stride),u=await B(i.shape,i.stride),S=await Promise.all(d.gridData.map(async v=>await at(v.offset,e.shape)));N(c),k(d),H(u),O(S)}catch(e){I(e instanceof Error?e.message:"Unknown error"),N({gridData:[],rows:0,cols:0,parsedLayout:null,colCoords:[],rowCoords:[]}),k({gridData:[],rows:0,cols:0,parsedLayout:null,colCoords:[],rowCoords:[]}),H({gridData:[],rows:0,cols:0,parsedLayout:null,colCoords:[],rowCoords:[]}),O([])}})()},[p,y]),s.useEffect(()=>{if(o.gridData.length>0&&l===null){const t=Math.floor(o.gridData.length/2),e=o.gridData[t];L({row:e.row,col:e.col})}},[o.gridData,l]);const[C,T]=s.useState(0),[x,U]=s.useState(0);s.useEffect(()=>{const t=[...r.gridData.map(e=>e.offset),...o.gridData.map(e=>e.offset),...g.gridData.map(e=>e.offset)];t.length===0?(T(0),U(0)):(T(Math.min(...t)),U(Math.max(...t)))},[r.gridData,o.gridData,g.gridData]);const[G,Q]=s.useState([]);s.useEffect(()=>{(async()=>{const e=[];if(l&&o.gridData.length>0&&r.gridData.length>0){const c=o.gridData[l.row*o.cols+l.col];if(c){const n=m[l.row*o.cols+l.col];if(n!==void 0){const d=await q(n,r.parsedLayout?.stride||0),i=r.gridData.find(u=>u.offset===d);i&&e.push({fromLayoutIdx:1,fromRow:c.row,fromCol:c.col,toRow:i.row,toCol:i.col})}}}Q(e)})()},[l,r,o,m]);const[V,X]=s.useState(new Set);s.useEffect(()=>{(async()=>{const e=new Set;if(l&&o.gridData.length>0&&o.gridData[l.row*o.cols+l.col]){const n=m[l.row*o.cols+l.col];if(n!==void 0){const d=await q(n,r.parsedLayout?.stride||0),i=r.gridData.find(u=>u.offset===d);i&&e.add(`${i.row},${i.col}`)}}X(e)})()},[l,r,o,m]);const[Y,Z]=s.useState(new Set);s.useEffect(()=>{const t=new Set;l&&t.add(`${l.row},${l.col}`),Z(t)},[l]);const _=()=>G.length===0?null:a.jsx("svg",{style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",zIndex:5},children:G.map((t,e)=>{let c,n;if(t.fromLayoutIdx===1?(c=R.current[t.fromRow*o.cols+t.fromCol],n=P.current[t.toRow*r.cols+t.toCol]):(c=M.current[t.fromRow*g.cols+t.fromCol],n=R.current[t.toRow*o.cols+t.toCol]),!c||!n)return null;const d=c.getBoundingClientRect(),i=n.getBoundingClientRect(),u=c.closest(".max-w-6xl")?.getBoundingClientRect();if(!u)return null;const S=d.left+d.width/2-u.left,v=d.top+d.height/2-u.top,z=i.left+i.width/2-u.left,tt=i.top+i.height/2-u.top;return a.jsx("line",{x1:S,y1:v,x2:z,y2:tt,stroke:"#3b82f6",strokeWidth:"2",strokeDasharray:"5,5"},e)})});return a.jsxs("div",{className:"max-w-6xl p-0 leading-relaxed text-black",style:{position:"relative"},children:[a.jsx("h1",{className:"text-4xl m-0 text-black mb-6",children:"Composition"}),a.jsxs("div",{className:"max-w-full",children:[a.jsxs("div",{className:"mb-4 max-w-4xl",children:[a.jsxs("div",{className:"bg-white rounded-lg shadow p-3 mb-3",children:[a.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-1",children:"Layout A (Outer Layout) - Shape:Stride"}),a.jsx("input",{type:"text",value:p,onChange:t=>j(t.target.value),className:"w-full px-3 py-2 border-2 border-gray-300 rounded focus:border-blue-500 focus:outline-none font-mono",placeholder:"e.g., (6,2):(8,2)"})]}),a.jsxs("div",{className:"bg-white rounded-lg shadow p-3 mb-3",children:[a.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-1",children:"Layout B (Inner Layout) - Shape:Stride"}),a.jsx("input",{type:"text",value:y,onChange:t=>E(t.target.value),className:"w-full px-3 py-2 border-2 border-gray-300 rounded focus:border-blue-500 focus:outline-none font-mono",placeholder:"e.g., (4,3):(3,1)"})]}),b&&a.jsxs("div",{className:"mt-2 text-red-600 text-sm font-medium bg-red-50 p-3 rounded",children:["⚠️ ",b]}),!b&&r.parsedLayout&&o.parsedLayout&&a.jsx("button",{onClick:()=>{const e=`${`${window.location.origin}${window.location.pathname}`}#/composition?layoutA=${p}&layoutB=${y}`;navigator.clipboard.writeText(e).then(()=>{$(!0),setTimeout(()=>$(!1),2e3)})},className:"mt-3 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded font-medium transition-colors",children:F?"✓ Link copied!":"Share This Composition"})]}),r.gridData.length>0&&o.gridData.length>0&&g.gridData.length>0&&a.jsx("div",{className:"bg-white rounded-lg shadow p-4 mb-4",children:a.jsx(ot,{heatmapEnabled:D,colorScheme:w,minOffset:C,maxOffset:x,onHeatmapToggle:J,onColorSchemeChange:K})}),r.gridData.length>0&&o.gridData.length>0&&g.gridData.length>0&&a.jsxs("div",{className:"space-y-6",children:[a.jsx(A,{grid:r,title:`Layout A: ${f(r.parsedLayout?.shape)}:${f(r.parsedLayout?.stride)}`,highlightedCells:V,cellRefs:P,heatmapEnabled:D,colorScheme:w,minOffset:C,maxOffset:x}),a.jsx(A,{grid:o,title:`Layout B: ${f(o.parsedLayout?.shape)}:${f(o.parsedLayout?.stride)} (Coordinates in A)`,showCoords:m,hoveredCell:l,onCellHover:(t,e)=>L({row:t,col:e}),onCellLeave:()=>{const t=Math.floor(o.gridData.length/2),e=o.gridData[t];L({row:e.row,col:e.col})},cellRefs:R,heatmapEnabled:!1,colorScheme:w,minOffset:C,maxOffset:x}),a.jsx(A,{grid:g,title:`Result (A ∘ B): ${f(g.parsedLayout?.shape)}:${f(g.parsedLayout?.stride)}`,highlightedCells:Y,cellRefs:M,heatmapEnabled:D,colorScheme:w,minOffset:C,maxOffset:x})]})]}),_()]})}export{it as default};
